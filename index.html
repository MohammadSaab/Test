<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Task Management</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    // Tailwind config + branding color
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { DEFAULT: 'rgb(0,174,141)', dark: 'rgb(0,150,122)', soft: 'rgba(0,174,141,.12)' }
          },
          boxShadow: {
            soft: '0 10px 30px rgba(2, 8, 23, .08)'
          }
        }
      }
    }
  </script>

  <style>
    /* Smooth scroll + nicer fonts */
    html { scroll-behavior: smooth; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <div class="min-h-screen flex">

    <!-- Sidebar -->
    <aside class="hidden lg:flex lg:w-72 flex-col bg-white border-r border-slate-200">
      <div class="px-6 py-5 border-b border-slate-200">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-2xl bg-brand/10 flex items-center justify-center">
            <div class="h-5 w-5 rounded-md bg-brand"></div>
          </div>
          <div>
            <div class="text-sm text-slate-500">Workspace</div>
            <div class="font-semibold leading-tight">Task Management</div>
          </div>
        </div>
      </div>

      <nav class="p-4 space-y-1">
        <button data-nav="dashboard" class="navBtn w-full flex items-center gap-3 px-3 py-2 rounded-xl bg-brand/10 text-brand">
          <span class="h-2 w-2 rounded-full bg-brand"></span>
          <span class="font-medium">Dashboard</span>
        </button>
        <button data-nav="mytasks" class="navBtn w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50">
          <span class="h-2 w-2 rounded-full bg-slate-300"></span>
          <span class="font-medium">My Tasks</span>
        </button>
        <button data-nav="team" class="navBtn w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50">
          <span class="h-2 w-2 rounded-full bg-slate-300"></span>
          <span class="font-medium">Team</span>
        </button>
        <button data-nav="reports" class="navBtn w-full flex items-center gap-3 px-3 py-2 rounded-xl hover:bg-slate-50">
          <span class="h-2 w-2 rounded-full bg-slate-300"></span>
          <span class="font-medium">Reports</span>
        </button>
      </nav>

      <div class="mt-auto p-4">
        <div class="rounded-2xl bg-slate-50 border border-slate-200 p-4">
          <div class="text-sm font-semibold">Brand color</div>
          <div class="text-xs text-slate-500 mt-1">rgb(0,174,141)</div>
          <div class="mt-3 flex items-center gap-2">
            <div class="h-3 w-10 rounded-full bg-brand"></div>
            <div class="h-3 w-10 rounded-full bg-brand/60"></div>
            <div class="h-3 w-10 rounded-full bg-brand/25"></div>
          </div>
        </div>
        <div class="text-[11px] text-slate-400 mt-3">
          Tip: if iframe caching happens, update URL with <span class="font-mono">?v=123</span>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1">
      <!-- Top bar -->
      <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-slate-200">
        <div class="px-4 sm:px-6 py-4 flex items-center gap-3">
          <button id="mobileMenuBtn" class="lg:hidden p-2 rounded-xl border border-slate-200 bg-white">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="text-slate-700">
              <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>

          <div class="flex-1">
            <div class="text-sm text-slate-500">Overview</div>
            <h1 class="text-xl sm:text-2xl font-semibold">Tasks Dashboard</h1>
          </div>

          <div class="hidden sm:flex items-center gap-2">
            <div class="relative">
              <input id="searchInput" class="w-72 rounded-2xl border border-slate-200 bg-white px-4 py-2 pl-10 outline-none focus:ring-2 focus:ring-brand/30"
                     placeholder="Search tasks..." />
              <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M21 21l-4.3-4.3M17 10.5A6.5 6.5 0 1 1 4 10.5a6.5 6.5 0 0 1 13 0Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>

            <button id="newTaskBtn" class="rounded-2xl bg-brand text-white px-4 py-2 font-medium hover:bg-brand-dark shadow-soft">
              + New Task
            </button>
          </div>
        </div>

        <!-- Mobile search + button -->
        <div class="sm:hidden px-4 pb-4 flex gap-2">
          <input id="searchInputMobile" class="flex-1 rounded-2xl border border-slate-200 bg-white px-4 py-2 outline-none focus:ring-2 focus:ring-brand/30"
                 placeholder="Search..." />
          <button id="newTaskBtnMobile" class="rounded-2xl bg-brand text-white px-4 py-2 font-medium hover:bg-brand-dark">
            + New
          </button>
        </div>
      </header>

      <div class="px-4 sm:px-6 py-6 space-y-6">

        <!-- Stats -->
        <section class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
          <div class="bg-white rounded-3xl border border-slate-200 p-5 shadow-soft">
            <div class="text-sm text-slate-500">Open</div>
            <div id="statOpen" class="text-3xl font-semibold mt-1">0</div>
            <div class="mt-3 h-2 rounded-full bg-slate-100 overflow-hidden">
              <div id="barOpen" class="h-full bg-brand w-0"></div>
            </div>
          </div>

          <div class="bg-white rounded-3xl border border-slate-200 p-5 shadow-soft">
            <div class="text-sm text-slate-500">In Progress</div>
            <div id="statProg" class="text-3xl font-semibold mt-1">0</div>
            <div class="mt-3 h-2 rounded-full bg-slate-100 overflow-hidden">
              <div id="barProg" class="h-full bg-brand/70 w-0"></div>
            </div>
          </div>

          <div class="bg-white rounded-3xl border border-slate-200 p-5 shadow-soft">
            <div class="text-sm text-slate-500">Done</div>
            <div id="statDone" class="text-3xl font-semibold mt-1">0</div>
            <div class="mt-3 h-2 rounded-full bg-slate-100 overflow-hidden">
              <div id="barDone" class="h-full bg-brand/40 w-0"></div>
            </div>
          </div>

          <div class="bg-white rounded-3xl border border-slate-200 p-5 shadow-soft">
            <div class="text-sm text-slate-500">Overdue</div>
            <div id="statOver" class="text-3xl font-semibold mt-1">0</div>
            <div class="mt-3 text-xs text-slate-500">Tasks past due date</div>
          </div>
        </section>

        <!-- Controls -->
        <section class="bg-white rounded-3xl border border-slate-200 p-4 sm:p-5 shadow-soft">
          <div class="flex flex-col xl:flex-row gap-3 xl:items-center xl:justify-between">
            <div class="flex flex-wrap gap-2">
              <button data-tab="all" class="tabBtn px-3 py-2 rounded-2xl bg-brand/10 text-brand font-medium">All</button>
              <button data-tab="open" class="tabBtn px-3 py-2 rounded-2xl hover:bg-slate-50">Open</button>
              <button data-tab="progress" class="tabBtn px-3 py-2 rounded-2xl hover:bg-slate-50">In Progress</button>
              <button data-tab="done" class="tabBtn px-3 py-2 rounded-2xl hover:bg-slate-50">Done</button>
            </div>

            <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
              <select id="priorityFilter" class="rounded-2xl border border-slate-200 bg-white px-3 py-2 outline-none focus:ring-2 focus:ring-brand/30">
                <option value="all">All priorities</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
                <option value="Low">Low</option>
              </select>

              <select id="sortBy" class="rounded-2xl border border-slate-200 bg-white px-3 py-2 outline-none focus:ring-2 focus:ring-brand/30">
                <option value="dueAsc">Sort: Due date (soonest)</option>
                <option value="dueDesc">Sort: Due date (latest)</option>
                <option value="prio">Sort: Priority</option>
                <option value="createdDesc">Sort: Recently added</option>
              </select>

              <button id="exportBtn" class="rounded-2xl border border-slate-200 px-3 py-2 hover:bg-slate-50">
                Export JSON
              </button>
              <button id="resetBtn" class="rounded-2xl border border-slate-200 px-3 py-2 hover:bg-slate-50">
                Reset demo
              </button>
            </div>
          </div>
        </section>

        <!-- Tasks list -->
        <section class="bg-white rounded-3xl border border-slate-200 shadow-soft overflow-hidden">
          <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
            <div>
              <div class="font-semibold">Tasks</div>
              <div id="resultsInfo" class="text-sm text-slate-500">0 items</div>
            </div>

            <div class="hidden sm:flex items-center gap-2 text-sm">
              <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-brand/10 text-brand">
                <span class="h-2 w-2 bg-brand rounded-full"></span> Brand
              </span>
            </div>
          </div>

          <div id="tasksWrap" class="divide-y divide-slate-200"></div>

          <div id="emptyState" class="hidden p-8 text-center">
            <div class="mx-auto h-12 w-12 rounded-2xl bg-brand/10 flex items-center justify-center">
              <div class="h-6 w-6 rounded-xl bg-brand/40"></div>
            </div>
            <div class="mt-3 font-semibold">No tasks found</div>
            <div class="text-sm text-slate-500 mt-1">Try changing filters or create a new task.</div>
            <button class="mt-4 rounded-2xl bg-brand text-white px-4 py-2 font-medium hover:bg-brand-dark" id="emptyNewBtn">
              + New Task
            </button>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Mobile sidebar drawer -->
  <div id="drawerBackdrop" class="hidden fixed inset-0 bg-black/30 z-40"></div>
  <div id="drawer" class="hidden fixed z-50 inset-y-0 left-0 w-80 bg-white border-r border-slate-200 shadow-soft">
    <div class="px-4 py-4 border-b border-slate-200 flex items-center justify-between">
      <div class="font-semibold">Menu</div>
      <button id="drawerClose" class="p-2 rounded-xl border border-slate-200">
        ✕
      </button>
    </div>
    <div class="p-4 space-y-1">
      <button class="w-full text-left px-3 py-2 rounded-xl bg-brand/10 text-brand font-medium">Dashboard</button>
      <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50">My Tasks</button>
      <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50">Team</button>
      <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50">Reports</button>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="hidden fixed inset-0 bg-black/30 z-50"></div>
  <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="w-full max-w-xl bg-white rounded-3xl border border-slate-200 shadow-soft overflow-hidden">
      <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
        <div class="font-semibold" id="modalTitle">New Task</div>
        <button id="modalClose" class="p-2 rounded-xl border border-slate-200 hover:bg-slate-50">✕</button>
      </div>

      <div class="p-5 space-y-4">
        <div>
          <label class="text-sm font-medium">Title</label>
          <input id="taskTitle" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2 outline-none focus:ring-2 focus:ring-brand/30" placeholder="e.g., Prepare client demo deck" />
        </div>

        <div>
          <label class="text-sm font-medium">Description</label>
          <textarea id="taskDesc" rows="3" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2 outline-none focus:ring-2 focus:ring-brand/30"
                    placeholder="Optional notes..."></textarea>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div>
            <label class="text-sm font-medium">Status</label>
            <select id="taskStatus" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2 outline-none focus:ring-2 focus:ring-brand/30">
              <option value="Open">Open</option>
              <option value="In Progress">In Progress</option>
              <option value="Done">Done</option>
            </select>
          </div>

          <div>
            <label class="text-sm font-medium">Priority</label>
            <select id="taskPriority" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2 outline-none focus:ring-2 focus:ring-brand/30">
              <option value="High">High</option>
              <option value="Medium" selected>Medium</option>
              <option value="Low">Low</option>
            </select>
          </div>

          <div>
            <label class="text-sm font-medium">Due date</label>
            <input id="taskDue" type="date" class="mt-1 w-full rounded-2xl border border-slate-200 px-3 py-2 outline-none focus:ring-2 focus:ring-brand/30" />
          </div>
        </div>

        <div class="flex items-center justify-between pt-2">
          <button id="deleteBtn" class="hidden text-red-600 hover:text-red-700 font-medium">Delete</button>
          <div class="flex gap-2 ml-auto">
            <button id="cancelBtn" class="rounded-2xl border border-slate-200 px-4 py-2 hover:bg-slate-50">Cancel</button>
            <button id="saveBtn" class="rounded-2xl bg-brand text-white px-4 py-2 font-medium hover:bg-brand-dark">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Storage ----------
    const STORAGE_KEY = "tm_tasks_v1";

    const nowISO = () => new Date().toISOString();
    const todayYMD = () => new Date().toISOString().slice(0,10);

    function loadTasks() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch { return null; }
    }

    function saveTasks(tasks) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
    }

    // ---------- Demo seed ----------
    function seedDemo() {
      const t = todayYMD();
      const plusDays = (d) => {
        const dt = new Date();
        dt.setDate(dt.getDate() + d);
        return dt.toISOString().slice(0,10);
      };
      return [
        { id: crypto.randomUUID(), title: "Prepare demo plan", desc: "Outline agenda & key scenarios for client demo.", status: "Open", priority: "High", due: plusDays(2), createdAt: nowISO() },
        { id: crypto.randomUUID(), title: "Update proposal timeline", desc: "Align milestones with delivery team.", status: "In Progress", priority: "Medium", due: plusDays(5), createdAt: nowISO() },
        { id: crypto.randomUUID(), title: "Review risks & assumptions", desc: "Confirm dependencies and exclusions.", status: "Open", priority: "Low", due: plusDays(10), createdAt: nowISO() },
        { id: crypto.randomUUID(), title: "Send follow-up email", desc: "Ask for API readiness & access.", status: "Done", priority: "Medium", due: plusDays(-1), createdAt: nowISO() },
      ];
    }

    let tasks = loadTasks();
    if (!tasks || !Array.isArray(tasks) || tasks.length === 0) {
      tasks = seedDemo();
      saveTasks(tasks);
    }

    // ---------- UI State ----------
    let currentTab = "all";
    let searchQuery = "";
    let priority = "all";
    let sortBy = "dueAsc";
    let editingId = null;

    // ---------- Elements ----------
    const tasksWrap = document.getElementById("tasksWrap");
    const emptyState = document.getElementById("emptyState");
    const resultsInfo = document.getElementById("resultsInfo");

    const statOpen = document.getElementById("statOpen");
    const statProg = document.getElementById("statProg");
    const statDone = document.getElementById("statDone");
    const statOver = document.getElementById("statOver");

    const barOpen = document.getElementById("barOpen");
    const barProg = document.getElementById("barProg");
    const barDone = document.getElementById("barDone");

    const searchInput = document.getElementById("searchInput");
    const searchInputMobile = document.getElementById("searchInputMobile");

    const priorityFilter = document.getElementById("priorityFilter");
    const sortSelect = document.getElementById("sortBy");

    const newTaskBtn = document.getElementById("newTaskBtn");
    const newTaskBtnMobile = document.getElementById("newTaskBtnMobile");
    const emptyNewBtn = document.getElementById("emptyNewBtn");

    const exportBtn = document.getElementById("exportBtn");
    const resetBtn = document.getElementById("resetBtn");

    // Modal elements
    const modalBackdrop = document.getElementById("modalBackdrop");
    const modal = document.getElementById("modal");
    const modalClose = document.getElementById("modalClose");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveBtn = document.getElementById("saveBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const modalTitle = document.getElementById("modalTitle");

    const taskTitle = document.getElementById("taskTitle");
    const taskDesc = document.getElementById("taskDesc");
    const taskStatus = document.getElementById("taskStatus");
    const taskPriority = document.getElementById("taskPriority");
    const taskDue = document.getElementById("taskDue");

    // Drawer
    const mobileMenuBtn = document.getElementById("mobileMenuBtn");
    const drawerBackdrop = document.getElementById("drawerBackdrop");
    const drawer = document.getElementById("drawer");
    const drawerClose = document.getElementById("drawerClose");

    // ---------- Helpers ----------
    const prioRank = (p) => ({ High: 3, Medium: 2, Low: 1 }[p] || 0);
    const isOverdue = (t) => t.status !== "Done" && t.due && t.due < todayYMD();

    function badgeForStatus(s) {
      if (s === "Done") return "bg-emerald-50 text-emerald-700 border-emerald-200";
      if (s === "In Progress") return "bg-amber-50 text-amber-700 border-amber-200";
      return "bg-slate-50 text-slate-700 border-slate-200";
    }
    function badgeForPriority(p) {
      if (p === "High") return "bg-red-50 text-red-700 border-red-200";
      if (p === "Medium") return "bg-blue-50 text-blue-700 border-blue-200";
      return "bg-slate-50 text-slate-700 border-slate-200";
    }

    // ---------- Filtering + Sorting ----------
    function getViewTasks() {
      let list = [...tasks];

      // tab filter
      if (currentTab === "open") list = list.filter(t => t.status === "Open");
      if (currentTab === "progress") list = list.filter(t => t.status === "In Progress");
      if (currentTab === "done") list = list.filter(t => t.status === "Done");

      // priority filter
      if (priority !== "all") list = list.filter(t => t.priority === priority);

      // search filter
      const q = searchQuery.trim().toLowerCase();
      if (q) {
        list = list.filter(t =>
          (t.title || "").toLowerCase().includes(q) ||
          (t.desc || "").toLowerCase().includes(q) ||
          (t.status || "").toLowerCase().includes(q) ||
          (t.priority || "").toLowerCase().includes(q)
        );
      }

      // sort
      list.sort((a,b) => {
        if (sortBy === "dueAsc") return (a.due || "9999-12-31").localeCompare(b.due || "9999-12-31");
        if (sortBy === "dueDesc") return (b.due || "0000-01-01").localeCompare(a.due || "0000-01-01");
        if (sortBy === "prio") return prioRank(b.priority) - prioRank(a.priority);
        if (sortBy === "createdDesc") return (b.createdAt || "").localeCompare(a.createdAt || "");
        return 0;
      });

      return list;
    }

    // ---------- Render ----------
    function renderStats() {
      const open = tasks.filter(t => t.status === "Open").length;
      const prog = tasks.filter(t => t.status === "In Progress").length;
      const done = tasks.filter(t => t.status === "Done").length;
      const over = tasks.filter(isOverdue).length;
      const total = Math.max(tasks.length, 1);

      statOpen.textContent = open;
      statProg.textContent = prog;
      statDone.textContent = done;
      statOver.textContent = over;

      barOpen.style.width = Math.round((open/total)*100) + "%";
      barProg.style.width = Math.round((prog/total)*100) + "%";
      barDone.style.width = Math.round((done/total)*100) + "%";
    }

    function renderList() {
      const view = getViewTasks();
      resultsInfo.textContent = `${view.length} item${view.length === 1 ? "" : "s"}`;

      tasksWrap.innerHTML = "";
      emptyState.classList.toggle("hidden", view.length !== 0);

      for (const t of view) {
        const overdue = isOverdue(t);

        const row = document.createElement("div");
        row.className = "p-5 hover:bg-slate-50 transition";
        row.innerHTML = `
          <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
            <div class="min-w-0">
              <div class="flex items-start gap-3">
                <button class="toggleDone mt-1 h-6 w-6 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 flex items-center justify-center"
                        title="Toggle done" data-id="${t.id}">
                  ${t.status === "Done"
                    ? `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="text-brand">
                         <path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
                       </svg>`
                    : `<span class="h-2 w-2 rounded-full bg-slate-300"></span>`}
                </button>

                <div class="min-w-0">
                  <div class="flex flex-wrap items-center gap-2">
                    <div class="font-semibold truncate">${escapeHtml(t.title || "(Untitled)")}</div>
                    ${overdue ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs border bg-red-50 text-red-700 border-red-200">
                                  <span class="h-1.5 w-1.5 bg-red-500 rounded-full"></span> Overdue
                                </span>` : ""}
                  </div>
                  <div class="text-sm text-slate-500 mt-1 line-clamp-2">${escapeHtml(t.desc || "")}</div>
                  <div class="mt-2 flex flex-wrap items-center gap-2 text-xs">
                    <span class="inline-flex items-center px-2 py-1 rounded-full border ${badgeForStatus(t.status)}">
                      ${escapeHtml(t.status)}
                    </span>
                    <span class="inline-flex items-center px-2 py-1 rounded-full border ${badgeForPriority(t.priority)}">
                      ${escapeHtml(t.priority)}
                    </span>
                    <span class="inline-flex items-center px-2 py-1 rounded-full border bg-white text-slate-600 border-slate-200">
                      Due: <span class="ml-1 font-medium ${overdue ? "text-red-700" : "text-slate-800"}">${escapeHtml(t.due || "—")}</span>
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex items-center gap-2">
              <button class="editBtn rounded-2xl border border-slate-200 px-3 py-2 hover:bg-white bg-white"
                      data-id="${t.id}">
                Edit
              </button>
              <button class="quickProgress rounded-2xl border border-slate-200 px-3 py-2 hover:bg-white bg-white"
                      data-id="${t.id}">
                Next status →
              </button>
            </div>
          </div>
        `;
        tasksWrap.appendChild(row);
      }
    }

    function renderAll() {
      renderStats();
      renderList();
      wireRowActions();
    }

    function wireRowActions() {
      document.querySelectorAll(".editBtn").forEach(btn => {
        btn.addEventListener("click", () => openModal(btn.dataset.id));
      });

      document.querySelectorAll(".toggleDone").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          const t = tasks.find(x => x.id === id);
          if (!t) return;
          t.status = (t.status === "Done") ? "Open" : "Done";
          persistAndRender();
        });
      });

      document.querySelectorAll(".quickProgress").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          const t = tasks.find(x => x.id === id);
          if (!t) return;
          t.status = nextStatus(t.status);
          persistAndRender();
        });
      });
    }

    function nextStatus(s) {
      if (s === "Open") return "In Progress";
      if (s === "In Progress") return "Done";
      return "Open";
    }

    function persistAndRender() {
      saveTasks(tasks);
      renderAll();
    }

    // ---------- Modal ----------
    function openModal(id = null) {
      editingId = id;
      const isEdit = !!id;
      modalTitle.textContent = isEdit ? "Edit Task" : "New Task";
      deleteBtn.classList.toggle("hidden", !isEdit);

      if (isEdit) {
        const t = tasks.find(x => x.id === id);
        taskTitle.value = t?.title || "";
        taskDesc.value = t?.desc || "";
        taskStatus.value = t?.status || "Open";
        taskPriority.value = t?.priority || "Medium";
        taskDue.value = t?.due || "";
      } else {
        taskTitle.value = "";
        taskDesc.value = "";
        taskStatus.value = "Open";
        taskPriority.value = "Medium";
        taskDue.value = "";
      }

      modalBackdrop.classList.remove("hidden");
      modal.classList.remove("hidden");
      setTimeout(() => taskTitle.focus(), 50);
    }

    function closeModal() {
      modalBackdrop.classList.add("hidden");
      modal.classList.add("hidden");
      editingId = null;
    }

    function validate() {
      const title = taskTitle.value.trim();
      if (!title) {
        taskTitle.focus();
        taskTitle.classList.add("ring-2", "ring-red-300");
        setTimeout(() => taskTitle.classList.remove("ring-2", "ring-red-300"), 700);
        return false;
      }
      return true;
    }

    saveBtn.addEventListener("click", () => {
      if (!validate()) return;

      const payload = {
        title: taskTitle.value.trim(),
        desc: taskDesc.value.trim(),
        status: taskStatus.value,
        priority: taskPriority.value,
        due: taskDue.value || ""
      };

      if (editingId) {
        const t = tasks.find(x => x.id === editingId);
        if (!t) return;
        Object.assign(t, payload);
      } else {
        tasks.unshift({
          id: crypto.randomUUID(),
          createdAt: nowISO(),
          ...payload
        });
      }

      persistAndRender();
      closeModal();
    });

    deleteBtn.addEventListener("click", () => {
      if (!editingId) return;
      tasks = tasks.filter(t => t.id !== editingId);
      saveTasks(tasks);
      closeModal();
      renderAll();
    });

    modalClose.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", closeModal);

    // ---------- Tabs / Filters ----------
    document.querySelectorAll(".tabBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        currentTab = btn.dataset.tab;

        document.querySelectorAll(".tabBtn").forEach(b => {
          b.classList.remove("bg-brand/10", "text-brand", "font-medium");
          b.classList.add("hover:bg-slate-50");
        });

        btn.classList.add("bg-brand/10", "text-brand", "font-medium");
        btn.classList.remove("hover:bg-slate-50");

        renderAll();
      });
    });

    priorityFilter.addEventListener("change", () => {
      priority = priorityFilter.value;
      renderAll();
    });

    sortSelect.addEventListener("change", () => {
      sortBy = sortSelect.value;
      renderAll();
    });

    // ---------- Search ----------
    function setSearch(v) {
      searchQuery = v || "";
      renderAll();
    }

    if (searchInput) searchInput.addEventListener("input", () => setSearch(searchInput.value));
    if (searchInputMobile) searchInputMobile.addEventListener("input", () => {
      setSearch(searchInputMobile.value);
      if (searchInput) searchInput.value = searchInputMobile.value;
    });

    // ---------- Buttons ----------
    newTaskBtn?.addEventListener("click", () => openModal());
    newTaskBtnMobile?.addEventListener("click", () => openModal());
    emptyNewBtn?.addEventListener("click", () => openModal());

    exportBtn.addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(tasks, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "tasks.json";
      a.click();
      URL.revokeObjectURL(a.href);
    });

    resetBtn.addEventListener("click", () => {
      tasks = seedDemo();
      saveTasks(tasks);
      currentTab = "all";
      priority = "all";
      sortBy = "dueAsc";
      searchQuery = "";
      if (searchInput) searchInput.value = "";
      if (searchInputMobile) searchInputMobile.value = "";
      priorityFilter.value = "all";
      sortSelect.value = "dueAsc";
      document.querySelector('[data-tab="all"]')?.click();
      renderAll();
    });

    // ---------- Drawer ----------
    function openDrawer() {
      drawerBackdrop.classList.remove("hidden");
      drawer.classList.remove("hidden");
    }
    function closeDrawer() {
      drawerBackdrop.classList.add("hidden");
      drawer.classList.add("hidden");
    }

    mobileMenuBtn.addEventListener("click", openDrawer);
    drawerClose.addEventListener("click", closeDrawer);
    drawerBackdrop.addEventListener("click", closeDrawer);

    // ---------- Utilities ----------
    function escapeHtml(str) {
      return (str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // Initial render
    renderAll();
  </script>
</body>
</html>
